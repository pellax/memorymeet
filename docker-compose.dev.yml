# ================================================================================================
# üê≥ DOCKER COMPOSE - Development Environment (Simplified)
# ================================================================================================
# Version simplificada para desarrollo r√°pido con Mock n8n
#
# Uso:
#   docker-compose -f docker-compose.dev.yml up --build
#   docker-compose -f docker-compose.dev.yml down
#   docker-compose -f docker-compose.dev.yml logs -f

version: '3.8'

services:
  
  # ================================================================================================
  # üíæ PostgreSQL Database
  # ================================================================================================
  postgres:
    image: postgres:15-alpine
    container_name: memorymeet-postgres-dev
    environment:
      POSTGRES_USER: memorymeet
      POSTGRES_PASSWORD: dev_password_change_in_prod
      POSTGRES_DB: memorymeet_dev
    ports:
      - "5432:5432"
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U memorymeet"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - memorymeet-dev
    restart: unless-stopped

  # ================================================================================================
  # ‚ö° Redis Cache
  # ================================================================================================
  redis:
    image: redis:7-alpine
    container_name: memorymeet-redis-dev
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_dev_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - memorymeet-dev
    restart: unless-stopped

  # ================================================================================================
  # üß™ Mock n8n Server
  # ================================================================================================
  mock-n8n:
    build:
      context: ./backend/tests/mocks
      dockerfile: Dockerfile.mock-n8n
    container_name: memorymeet-mock-n8n-dev
    environment:
      - GATEKEEPER_CALLBACK_URL=http://gatekeeper:8002/api/v1/consumption/process/callback
    ports:
      - "5678:5678"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5678/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - memorymeet-dev
    restart: unless-stopped

  # ================================================================================================
  # üí∞ Gatekeeper Backend
  # ================================================================================================
  gatekeeper:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: development
    container_name: memorymeet-gatekeeper-dev
    environment:
      # Application
      ENVIRONMENT: development
      DEBUG: "true"
      HOST: "0.0.0.0"
      PORT: "8002"
      
      # Database
      DATABASE_URL: postgresql://memorymeet:dev_password_change_in_prod@postgres:5432/memorymeet_dev
      
      # Redis
      REDIS_URL: redis://redis:6379/0
      
      # n8n Webhook (apunta al mock)
      N8N_WEBHOOK_URL: http://mock-n8n:5678/webhook/process-meeting
      N8N_TIMEOUT_SECONDS: "30"
      N8N_MAX_RETRIES: "3"
      
      # Security (development keys)
      JWT_SECRET_KEY: dev-secret-key-change-in-production
      
      # Logging
      LOG_LEVEL: INFO
    ports:
      - "8002:8002"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      mock-n8n:
        condition: service_started
    volumes:
      # Mount code for hot reload in development
      - ./backend/app:/app/app
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - memorymeet-dev
    restart: unless-stopped

# ================================================================================================
# üì¶ Volumes
# ================================================================================================
volumes:
  postgres_dev_data:
    name: memorymeet-postgres-dev-data
  redis_dev_data:
    name: memorymeet-redis-dev-data

# ================================================================================================
# üåê Networks
# ================================================================================================
networks:
  memorymeet-dev:
    name: memorymeet-dev-network
    driver: bridge
